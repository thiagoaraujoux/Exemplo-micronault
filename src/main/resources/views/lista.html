<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Listas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css">
    <style>
        .list-card {
            margin-bottom: 1.5rem;
        }

        .modal-card-body .field {
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <nav class="navbar is-dark" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/">
                Minhas Listas
            </a>
        </div>
        <div id="navbarBasicExample" class="navbar-menu">
            <div class="navbar-start">
                <a class="navbar-item" href="/listas">Listas</a>
                <a class="navbar-item" href="/categorias">Categorias</a>
            </div>
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="has-text-weight-bold has-text-white"
                        th:text="'Bem-vindo, ' + ${currentUserName} + '!'">Bem-vindo!</span>
                </div>
                <div class="navbar-item">
                    <div class="buttons">
                        <a class="button is-light" href="/logout">Sair</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <h1 class="title">Minhas Listas de Tarefas</h1>

            <div id="message-area">
                <div th:if="${erro}" class="notification is-danger">
                    <button class="delete"></button>
                    <p th:text="${erro}"></p>
                </div>
                <div th:if="${sucesso}" class="notification is-success">
                    <button class="delete"></button>
                    <p th:text="${sucesso}"></p>
                </div>
            </div>

            <hr>

            <h2 class="subtitle">Criar Nova Lista</h2>
            <form id="createListForm" action="/listas" method="post">
                <div class="field">
                    <label class="label" for="titulo">Título</label>
                    <div class="control">
                        <input class="input" type="text" id="titulo" name="titulo" placeholder="Título da Lista"
                            required>
                    </div>
                </div>
                <div class="field">
                    <label class="label" for="descricao">Descrição</label>
                    <div class="control">
                        <textarea class="textarea" id="descricao" name="descricao"
                            placeholder="Descrição da Lista"></textarea>
                    </div>
                </div>
                <div class="field">
                    <label class="label" for="categoriaId">Categoria</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="categoriaId" name="categoriaId">
                                <option value="">Nenhuma Categoria</option>
                                <option th:each="categoria : ${categorias}" th:value="${categoria.id}"
                                    th:text="${categoria.nome}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-primary" type="submit">Salvar Lista</button>
                    </div>
                </div>
            </form>

            <hr>

            <h2 class="subtitle">Minhas Listas Existentes</h2>
            <div th:if="${listas.isEmpty()}" class="notification is-info">
                Você ainda não tem nenhuma lista. Crie uma acima!
            </div>
            <div class="columns is-multiline">
                <div class="column is-one-third" th:each="lista : ${listas}">
                    <div class="card list-card">
                        <div class="card-content">
                            <p class="title is-4" th:text="${lista.titulo}"></p>
                            <p class="subtitle is-6" th:text="${lista.descricao}"></p>
                            <p class="is-size-7 has-text-grey"
                                th:text="'Criado em: ' + ${#temporals.format(lista.dataCriacao, 'dd/MM/yyyy')}"></p>
                            <p th:if="${lista.categoria != null}" class="tag is-info mt-2"
                                th:text="${lista.categoria.nome}"></p>
                            <p th:unless="${lista.categoria != null}" class="tag is-light mt-2">Sem Categoria</p>
                        </div>
                        <footer class="card-footer">
                            <a href="#" class="card-footer-item edit-list-button" th:data-id="${lista.id}"
                                th:data-titulo="${lista.titulo}" th:data-descricao="${lista.descricao}"
                                th:data-categoria-id="${lista.categoria != null ? lista.categoria.id : ''}">
                                Editar
                            </a>
                            <a href="#" class="card-footer-item delete-list-button" th:data-id="${lista.id}">
                                Deletar
                            </a>
                        </footer>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal" id="editListModal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Editar Lista</p>
                <button class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <input type="hidden" id="editListId">
                <input type="hidden" id="currentUserId" th:value="${currentUserId}">

                <div class="field">
                    <label class="label" for="editTitulo">Título</label>
                    <div class="control">
                        <input class="input" type="text" id="editTitulo" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label" for="editDescricao">Descrição</label>
                    <div class="control">
                        <textarea class="textarea" id="editDescricao"></textarea>
                    </div>
                </div>
                <div class="field">
                    <label class="label" for="editCategoriaId">Categoria</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="editCategoriaId">
                                <option value="">Nenhuma Categoria</option>
                                <option th:each="categoria : ${categorias}" th:value="${categoria.id}"
                                    th:text="${categoria.nome}"></option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" id="saveEditButton">Salvar Alterações</button>
                <button class="button" id="cancelEditButton">Cancelar</button>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Dismiss Bulma notifications
            (document.querySelectorAll('.notification .delete') || []).forEach(($delete) => {
                const $notification = $delete.parentNode;
                $delete.addEventListener('click', () => {
                    $notification.parentNode.removeChild($notification);
                });
            });

            // Edit List Modal Logic
            const editListModal = document.getElementById('editListModal');
            const editListIdInput = document.getElementById('editListId');
            const editTituloInput = document.getElementById('editTitulo');
            const editDescricaoInput = document.getElementById('editDescricao');
            const editCategoriaIdSelect = document.getElementById('editCategoriaId');
            const saveEditButton = document.getElementById('saveEditButton');
            const cancelEditButton = document.getElementById('cancelEditButton');

            document.querySelectorAll('.edit-list-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    const listId = button.dataset.id;
                    const titulo = button.dataset.titulo;
                    const descricao = button.dataset.descricao;
                    const categoriaId = button.dataset.categoriaId; // This will be "" if no category

                    editListIdInput.value = listId;
                    editTituloInput.value = titulo;
                    editDescricaoInput.value = descricao;

                    // Select the correct category in the dropdown
                    if (categoriaId) {
                        editCategoriaIdSelect.value = categoriaId;
                    } else {
                        editCategoriaIdSelect.value = ''; // No category selected
                    }

                    editListModal.classList.add('is-active');
                });
            });

            // Close modal functionality
            const closeEditModal = () => {
                editListModal.classList.remove('is-active');
            };
            document.querySelector('#editListModal .delete').addEventListener('click', closeEditModal);
            cancelEditButton.addEventListener('click', closeEditModal);
            document.querySelector('#editListModal .modal-background').addEventListener('click', closeEditModal);

            // Save Edit Button Click (This sends JSON to the API controller)
            saveEditButton.addEventListener('click', () => {
                const listId = editListIdInput.value;
                const selectedCategoriaId = editCategoriaIdSelect.value; // Get the selected value

                const updatedData = {
                    titulo: editTituloInput.value,
                    descricao: editDescricaoInput.value,
                    // Send null if no category is selected, otherwise parse to int
                    categoriaId: selectedCategoriaId === '' ? null : parseInt(selectedCategoriaId)
                };

                fetch(`/api/listas/${listId}`, { // Assuming a separate API controller for PUT
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = '/listas?sucesso=lista_atualizada';
                        } else {
                            response.text().then(text => {
                                let errorMessage = 'Erro ao atualizar a lista.';
                                try {
                                    const errorJson = JSON.parse(text);
                                    errorMessage = errorJson.message || errorJson.detail || errorMessage;
                                } catch (e) {
                                    errorMessage = text || errorMessage;
                                }
                                window.location.href = '/listas?erro=' + encodeURIComponent(errorMessage);
                            }).catch(() => {
                                window.location.href = '/listas?erro=Erro desconhecido ao atualizar a lista.';
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error updating list:', error);
                        window.location.href = '/listas?erro=Erro de rede ao atualizar a lista.';
                    });
            });

            // Delete List Button Click (This sends JSON to the API controller)
            document.querySelectorAll('.delete-list-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    const listId = button.dataset.id;

                    if (confirm('Tem certeza que deseja deletar esta lista?')) {
                        fetch(`/api/listas/${listId}`, { // Assuming a separate API controller for DELETE
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => {
                                if (response.ok || response.status === 204) { // 204 No Content for successful delete
                                    window.location.href = '/listas?sucesso=lista_deletada';
                                } else {
                                    response.text().then(text => {
                                        let errorMessage = 'Erro ao deletar a lista.';
                                        try {
                                            const errorJson = JSON.parse(text);
                                            errorMessage = errorJson.message || errorJson.detail || errorMessage;
                                        } catch (e) {
                                            errorMessage = text || errorMessage;
                                        }
                                        window.location.href = '/listas?erro=' + encodeURIComponent(errorMessage);
                                    }).catch(() => {
                                        window.location.href = '/listas?erro=Erro desconhecido ao deletar a lista.';
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error deleting list:', error);
                                window.location.href = '/listas?erro=Erro de rede ao deletar a lista.';
                            });
                    }
                });
            });
        });
    </script>
</body>

</html>